# Vol.27 MySQL

——————————————————————————————————————————      

## 27.1、DQL 数据查询

### 27.1.1 排序查询

- 排序方式
    - ASC : 升序，从小到大，默认。

    - DESC : 降序
——————————————————————————————————————————      

```sql
/* 默认按 字段 math 从小到大排序， */
select * from student order by math;

/* 指定按 math 从小到大排序 */
select * from student order by math ASC;

/* 从大到小 */
select * from student order by math DESC;

/* 
    多个字段联合排序，
    第一优先级math，
    第二优先级english，
    先按math的从小到大排序，math相同的项，按english从大到小排    
 */
select * from student order by math ASC, english DESC;
```
——————————————————————————————————————————      

### 27.1.2 聚合函数

聚合函数啥意思？    
将一列数据作为一个整体，进行纵向的计算。    

- 1、 count：计算个数
    - 	1、 一般选择非空的列：主键
    - 	2、 也可以用 count(*) ，但是不推荐

- 2、 max：计算最大值
- 3、 min：计算最小值
- 4、 sum：计算和
- 5、 avg：计算平均值

——————————————————————————————————————————      

```sql
/* 计算 name 为非空的个数  */
select COUNT(name) from student;

/* 如果要将null也计算进来，可以加个ifnull */
select COUNT(ifnull(math,0)) from student;
select COUNT(*) from student;   -- 也可以用*，但是不推荐

/* 获取最大值 最小值 */
select MAX(math) from student;
select MIN(math) from student;

/* 获取总和 */
select SUM(math) from student;

/* 获取平均值 */
select AVG(english) from student;
```
——————————————————————————————————————————      

> Tips：        
> 聚合函数的计算，如何排除null值？      
> 1. 选择不包含非空的列进行计算     
> 2. IFNULL函数     

——————————————————————————————————————————      

### 27.1.3 分组查询

```sql
/* 先找出sex math，然后按 sex 分类 */
select sex,avg(math) from student group by sex;

select sex,avg(math),count(id) from student group by sex;
```

- where
    - where 先进行条件筛选，再进行分组，不能后接聚合函数
- having
    - having 先进行分组，再进行条件筛选，后面可以接聚合函数

——————————————————————————————————————————      

### 27.1.4 分页

```sql
/**
    参数一，是当前页开始的索引
    参数二，是每页的条数

    注意：limit是mysql特有的语法
 */
select * from student limit 0,3;
select * from student limit 3,3;
select * from student limit 6,3;
```
——————————————————————————————————————————      

## 27.2、约束

约束，就是对表中的数据进行限定，    
保证数据的正确性、有效性和完整性。	    

- 1、 主键约束：primary key
- 2、 非空约束：not null
- 3、 唯一约束：unique
- 4、 外键约束：foreign key

——————————————————————————————————————————      
1、非空约束

```sql
CREATE TABLE stu(
	id INT,
	NAME VARCHAR(20) NOT NULL -- name为非空，在类型的后面加上约束
);

/* 创建表完后，添加非空约束 */
ALTER TABLE stu MODIFY NAME VARCHAR(20) NOT NULL;

/* 删除name的非空约束 */
ALTER TABLE stu MODIFY NAME VARCHAR(20);
```
——————————————————————————————————————————      
2、唯一约束

> Tips:     
> MySQL中，有unique约束的列，可以存在多个null   

```sql

CREATE TABLE stu(
	id INT,
	phone_number VARCHAR(20) UNIQUE -- 添加了唯一约束
);

/* 删除唯一约束 */
ALTER TABLE stu DROP INDEX phone_number;

/* 在创建表后，添加唯一约束 */
ALTER TABLE stu MODIFY phone_number VARCHAR(20) UNIQUE;
```
——————————————————————————————————————————      
3、主键约束

主键
- 非空、唯一
- 一张表只能有一个主键字段
- 主键是表中的唯一标识

```sql
create table stu(
	id int primary key,     -- 给id添加主键约束
	name varchar(20)
);

/* 删除主键，注意这里不能用modify，要用drop */
-- 错误 alter table stu modify id int ;
ALTER TABLE stu DROP PRIMARY KEY;

/* 创建完表后，添加主键 */
ALTER TABLE stu MODIFY id INT PRIMARY KEY;
```

给主键增加自动增长
> 如果某一列是数值类型的，  
> 使用 auto_increment 可以来完成值得自动增长        

```sql
create table stu(
	id int primary key auto_increment, -- 给id添加主键约束，然后加上自动增长
	name varchar(20)
);

/* 删除自动增长 */
ALTER TABLE stu MODIFY id INT;

/* 添加自动增长 */
ALTER TABLE stu MODIFY id INT AUTO_INCREMENT;
```

——————————————————————————————————————————      
4、外键约束

表和表之间产生关系，保证数据的正确性。

> 例如：    
> 一个表中的数据冗余，可以新起一个表来存放精简的冗余数据，  
> 但是此时两个表需要建立关联，  

```sql
create table employee(
    id int primary key,

    -- 外键名
    dep_id int,
    /* 
        定义外键约束，将当前表的 外键 和 其他表的主键 相关联  
        其中，emp_dept_fk 是外键约束字段
    */
    constraint emp_dept_fk foreign key (dep_id) references department(id)
)

create table department(
    id int primary key,
    name varchar(20)
)
```

```sql
/* 删除外键 */
ALTER TABLE employee DROP FOREIGN KEY emp_dept_fk;

/* 创建表之后，添加外键 */
ALTER TABLE 
    employee 
ADD CONSTRAINT 
    emp_dept_fk FOREIGN KEY (dept_id) 
REFERENCES 
    department(id);
```
——————————————————————————————————————————      

5、级联约束 → 有风险，需要谨慎使用，表间关系越多，这个操作风险越大

在外键约束的基础上，        
表关联后，需要改外键的值，这时候需要将关联的其他数据的键值也改掉。  


**将级联约束加到外键约束定义的末尾就行**
- on update cascade 级联更新

- on delete cascade 级联删除 → 风险最大

```sql
ALTER TABLE 
    employee 
ADD CONSTRAINT 
    emp_dept_fk FOREIGN KEY (dept_id) 
REFERENCES 
    department(id) ON UPDATE CASCADE ON DELETE CASCADE;
```

——————————————————————————————————————————      

## 27.3、数据库设计

多表关系
- 一对一
- 一对多
- 多对多

——————————————————————————————————————————      

如何实现？  

- 一对多：多的一方加外键，指向一的主键。

- 多对多：借助中间表，中间表至少两个字段。
    - 比如表A和表B，中间表C，C里面设置aid和bid，aid和bid是C的外键
    - aid指向A表的主键
    - bid指向B表的主键

- 一对一：一个表的唯一外键指向另一表的主键就可以了。
    - 这种情况其实很少见，因为既然都已经一对一了，为什么不只能把两表合并起来？

——————————————————————————————————————————      

数据库设计范式

- 第一范式：是要是一个表，都符合1NF
- 第二范式：1NF基础上，消除所有的非主属性对主属性的依赖；
- 第三范式：2NF基础上，消除所有的非主属性对非主属性的依赖；

——————————————————————————————————————————      

> 什么是码？    
>   
> 一张表中，一个属性或者属性组，被其他的属性完全依赖，  
> 这个属性或属性组就是码。  
>   
> - 主属性：码中的属性就是主属性
> - 非主属性：除了主属性之外的属性

——————————————————————————————————————————      

> 什么是依赖？  
> 通过A属性，可以确定B属性，那么A就是B的依赖。  
>   
> - 函数依赖    
> - 完全函数依赖    
> - 部分函数依赖    
> - 传递函数依赖    

——————————————————————————————————————————      

## 27.4、如何备份数据库

备份：
```cmd
mysqldump -uroot -p密码 数据库名称 > c:/a.sql
```
——————————————————————————————————————————      

还原：
- 登录数据库 mysql -uroot -p密码 数据库名称

- 创建数据库

- 使用数据库

- 执行命令导入sql文件
```cmd
source c:/a.sql
```
——————————————————————————————————————————      

> Tips：    
> 也可以直接用图形化工具。  

——————————————————————————————————————————      
